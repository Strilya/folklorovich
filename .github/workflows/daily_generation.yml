name: Daily Folklore Content Generation

on:
  # Run daily at 9:00 AM UTC
  schedule:
    - cron: '0 9 * * *'

  # Allow manual triggering from GitHub UI
  workflow_dispatch:

  # Trigger on push to main (for testing)
  push:
    branches:
      - main
    paths:
      - 'content/**'
      - 'scripts/**'

jobs:
  generate_content:
    name: Generate Daily Folklore Video
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          ffmpeg -version

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify dependencies
        run: |
          python --version
          pip list
          edge-tts --version

      - name: Create .env file
        run: |
          echo "UNSPLASH_ACCESS_KEY=${{ secrets.UNSPLASH_ACCESS_KEY }}" > .env
          echo "CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}" >> .env
          echo "LOG_LEVEL=INFO" >> .env

      - name: Generate daily content
        id: generate
        run: |
          python scripts/generate_daily_content.py
          echo "generation_status=$?" >> $GITHUB_OUTPUT

      - name: Check generation output
        run: |
          echo "Checking generated files..."
          ls -lh output/videos/ || echo "No videos generated"
          ls -lh output/images/ || echo "No images generated"
          ls -lh output/audio/ || echo "No audio generated"

      - name: Upload video artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: folklore-video-${{ github.run_number }}
          path: output/videos/*.mp4
          retention-days: 30
          if-no-files-found: warn

      - name: Upload collage artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: folklore-collage-${{ github.run_number }}
          path: output/images/*_collage.png
          retention-days: 7
          if-no-files-found: warn

      - name: Upload generation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generation-log-${{ github.run_number }}
          path: generation.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Commit updated metadata
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/metadata.json
          git diff --staged --quiet || git commit -m "Update metadata after daily generation [skip ci]"

      - name: Push metadata changes
        if: success()
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Daily content generation failed',
              body: `The daily content generation workflow failed.

              **Run ID:** ${{ github.run_id }}
              **Workflow:** ${{ github.workflow }}
              **Triggered by:** ${{ github.event_name }}
              **Date:** ${new Date().toISOString()}

              [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

              Please check the logs and fix the issue.`,
              labels: ['automation', 'bug']
            });
            console.log('Created issue:', issue.data.number);

  cleanup:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: generate_content

    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const days = 30;
            const timestamp = Date.now() - (days * 24 * 60 * 60 * 1000);

            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            let deletedCount = 0;
            for (const artifact of artifacts.data.artifacts) {
              if (new Date(artifact.created_at).getTime() < timestamp) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                deletedCount++;
              }
            }

            console.log(`Deleted ${deletedCount} old artifacts`);
